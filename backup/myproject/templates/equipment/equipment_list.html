{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% if page_title %}{{ page_title }}{% else %}{% trans "Equipment List" %}{% endif %}{% endblock %}

{% block content %}
<style>
    /* Target the base layout and navigation elements */
    body {
        overflow-x: auto; /* Allow horizontal scrolling for wide content */
    }

    /* Fix for navigation panel spacing - eliminate the red-marked gap */
    #content-wrapper {
        margin-left: 0 !important; /* Remove negative margin */
        padding-left: 0 !important; /* Remove padding that creates the gap */
        width: 100%; /* Use full width */
        max-width: none; /* Override any max-width */
    }
    
    /* Remove any unwanted parent container padding */
    #main-content, 
    #content, 
    .content-wrapper, 
    .content-container {
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        max-width: none !important;
        width: 100% !important;
    }
    
    /* Table styles */
    .equipment-table {
        font-size: 0.7rem; /* Reduce text size even further */
        width: 100%;
        table-layout: fixed; /* Fixed layout for better control */
    }
    .equipment-table th, 
    .equipment-table td {
        padding: 0.2rem 0.3rem; /* Reduce padding further */
        border: 1px solid #dee2e6;
        vertical-align: middle;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .equipment-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    /* Make the action buttons more compact */
    .btn-sm {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }
    
    /* Column widths for better fit */
    .equipment-table th:nth-child(1), .equipment-table td:nth-child(1) { width: 30px; } /* Nr.p. - narrower */
    .equipment-table th:nth-child(2), .equipment-table td:nth-child(2) { width: 150px; } /* Equipment/Measuring Instrument */
    .equipment-table th:nth-child(3), .equipment-table td:nth-child(3) { width: 100px; } /* Department */
    .equipment-table th:nth-child(4), .equipment-table td:nth-child(4) { width: 150px; } /* Name */
    .equipment-table th:nth-child(5), .equipment-table td:nth-child(5) { width: 80px; } /* Model */
    .equipment-table th:nth-child(6), .equipment-table td:nth-child(6) { width: 80px; } /* Type */
    .equipment-table th:nth-child(7), .equipment-table td:nth-child(7) { width: 120px; } /* Manufacturer */
    .equipment-table th:nth-child(8), .equipment-table td:nth-child(8) { width: 80px; } /* Inventory Nr. */
    .equipment-table th:nth-child(9), .equipment-table td:nth-child(9) { width: 90px; } /* Serial Number */
    .equipment-table th:nth-child(10), .equipment-table td:nth-child(10) { width: 100px; } /* Location */
    .equipment-table th:nth-child(11), .equipment-table td:nth-child(11) { width: 120px; } /* Type of Metrological Control */
    .equipment-table th:nth-child(12), .equipment-table td:nth-child(12) { width: 150px; } /* Metrological Control Institution */
    .equipment-table th:nth-child(13), .equipment-table td:nth-child(13) { width: 130px; } /* Certificate Nr. and Date */
    .equipment-table th:nth-child(14), .equipment-table td:nth-child(14) { width: 120px; } /* Metrological Control Periodicity */
    .equipment-table th:nth-child(15), .equipment-table td:nth-child(15) { width: 90px; } /* Next Verification Date */
    .equipment-table th:nth-child(16), .equipment-table td:nth-child(16) { width: 90px; } /* Technical Status */
    .equipment-table th:nth-child(17), .equipment-table td:nth-child(17) { width: 90px; } /* Documentation */
    .equipment-table th:nth-child(18), .equipment-table td:nth-child(18) { width: 110px; } /* Notes */
    .equipment-table th:nth-child(19), .equipment-table td:nth-child(19) { width: 130px; } /* Person Responsible */
    .equipment-table th:nth-child(20), .equipment-table td:nth-child(20) { width: 110px; } /* Additional Info */
    .equipment-table th:nth-child(21), .equipment-table td:nth-child(21) { width: 80px; } /* Actions - narrower */

    /* Diagnostic styles to identify layout issues */
    #content-wrapper {
        /* Remove the red outline */
        /* outline: 2px solid red; */  
    }
    
    /* Add this to see the relationship between navigation and content */
    @media (min-width: 768px) {
        #content-wrapper {
            /* This should align with navigation panel width */
            margin-left: 260px; /* Match nav-sidebar width from navigation.html */
            padding-left: 0;
        }
    }
    
    /* Add hover tooltip for truncated cell content */
    .equipment-table td {
        position: relative;
    }
    
    .equipment-table td:hover::after {
        content: attr(data-full-text);
        position: absolute;
        left: 0;
        top: 100%;
        z-index: 1000;
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 5px;
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
        white-space: normal;
        min-width: 200px;
        max-width: 300px;
        display: none;
    }
    
    .equipment-table td[data-full-text]:hover::after {
        display: block;
    }
    
    /* Column visibility toggle styles */
    .column-visibility-menu {
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        width: 250px;
        display: none; /* Hide menu by default */
    }
    
    /* Show menu when parent dropdown has 'show' class */
    .dropdown.show .column-visibility-menu {
        display: block;
    }
    
    /* Make dropdown more user-friendly */
    .column-toggle {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .column-toggle input {
        margin-right: 8px;
    }
    
    .column-toggle label {
        cursor: pointer;
        margin-bottom: 0;
        user-select: none;
    }
    
    /* Hidden column style */
    .hidden-column {
        display: none;
    }
    
    /* Sticky first column for better horizontal scrolling */
    .equipment-table th:first-child,
    .equipment-table td:first-child {
        position: sticky;
        left: 0;
        z-index: 2;
        background-color: #f8f9fa;
    }
    
    /* Styling for scroll buttons */
    .table-scroll-controls {
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
    }
    
    .table-scroll-controls button {
        padding: 3px 8px;
        font-size: 0.8rem;
    }
    
    /* Improve table scroll controls */
    .table-scroll-controls {
        margin-bottom: 15px; /* Increased bottom margin since indicator is removed */
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: #f8f9fa;
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .table-scroll-controls button {
        padding: 4px 10px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .table-scroll-controls .scroll-hint {
        color: #6c757d;
        font-size: 0.8rem;
        border-left: 1px solid #dee2e6;
        padding-left: 10px;
        margin-left: 5px;
    }

    /* Make sure table container has proper scrolling behavior */
    #table-container {
        overflow-x: auto;
        position: relative;
        max-width: 100%;
        scrollbar-width: thin; /* For Firefox */
        scrollbar-color: #6c757d #e9ecef; /* For Firefox */
    }

    /* Custom scrollbar for WebKit browsers */
    #table-container::-webkit-scrollbar {
        height: 8px;
    }

    #table-container::-webkit-scrollbar-track {
        background: #e9ecef;
        border-radius: 4px;
    }

    #table-container::-webkit-scrollbar-thumb {
        background-color: #6c757d;
        border-radius: 4px;
    }
</style>

<div class="container-fluid" id="content-wrapper">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2>{% if page_title %}{{ page_title }}{% else %}{% trans "Equipment List" %}{% endif %}</h2>
            <div class="d-flex">
                <!-- Column visibility dropdown - updated button text -->
                <div class="dropdown me-2">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="columnToggleDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-columns"></i> {% trans "Select Columns" %}
                    </button>
                    <div class="dropdown-menu column-visibility-menu" aria-labelledby="columnToggleDropdown">
                        <div class="column-toggle-all mb-2">
                            <button class="btn btn-sm btn-outline-primary" id="select-all-columns">{% trans "Select All" %}</button>
                            <button class="btn btn-sm btn-outline-secondary ms-1" id="deselect-all-columns">{% trans "Deselect All" %}</button>
                        </div>
                        <hr>
                        <!-- Column checkboxes will be inserted here by JavaScript -->
                    </div>
                </div>
                
                {% if departments %}
                <div class="dropdown me-2">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="departmentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        {% if selected_department %}
                            {% for dept in departments %}
                                {% if dept.id|stringformat:"s" == selected_department %}
                                    {{ dept.name }}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% trans "All Departments" %}
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="departmentDropdown">
                        <li><a class="dropdown-item" href="{% url 'equipment:equipment-list' %}">{% trans "All Departments" %}</a></li>
                        {% for dept in departments %}
                        <li><a class="dropdown-item" href="{% url 'equipment:equipment-list' %}?department={{ dept.id }}">{{ dept.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if perms.equipment.add_equipment %}
                <a href="{% url 'equipment:create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> {% trans "Add Equipment" %}
                </a>
                {% endif %}
            </div>
        </div>
        
        <div class="card-body">
            {% if no_migrations %}
                <div class="alert alert-warning">
                    <strong>{% trans "Database not set up" %}</strong>
                    <p>{% trans "The equipment database tables haven't been created yet. Please run migrations:" %}</p>
                    <pre>python manage.py makemigrations equipment
python manage.py migrate equipment</pre>
                </div>
            {% elif equipment_list %}
                <!-- Improved scroll controls -->
                <div class="table-scroll-controls">
                    <button class="btn btn-sm btn-outline-secondary" id="scroll-left">
                        <i class="fas fa-arrow-left"></i> {% trans "Scroll Left" %}
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="scroll-right">
                        {% trans "Scroll Right" %} <i class="fas fa-arrow-right"></i>
                    </button>
                    <span class="scroll-hint">{% trans "Or use arrow keys" %} <i class="fas fa-arrow-left"></i> <i class="fas fa-arrow-right"></i></span>
                </div>

                <div class="table-responsive" id="table-container">
                    <table class="table table-striped table-bordered table-sm equipment-table">
                        <thead class="thead-light">
                            <tr>
                                <th>{% trans "Nr.p." %}</th>
                                <th>{% trans "Equipment/Measuring Instrument" %}</th>
                                <th>{% trans "Department" %}</th>
                                <th>{% trans "Name" %}</th>
                                <th>{% trans "Model" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Manufacturer" %}</th>
                                <th>{% trans "Inventory Nr." %}</th>
                                <th>{% trans "Serial Number" %}</th>
                                <th>{% trans "Location" %}</th>
                                <th>{% trans "Type of Metrological Control" %}</th>
                                <th>{% trans "Metrological Control Institution" %}</th>
                                <th>{% trans "Certificate Nr. and Date" %}</th>
                                <th>{% trans "Metrological Control Periodicity" %}</th>
                                <th>{% trans "Next Verification Date" %}</th>
                                <th>{% trans "Technical Status" %}</th>
                                <th>{% trans "Documentation" %}</th>
                                <th>{% trans "Notes" %}</th>
                                <th>{% trans "Person Responsible" %}</th>
                                <th>{% trans "Additional Info" %}</th>
                                <th class="text-center">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for equipment in equipment_list %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ equipment.equipment_type_display }}</td>
                                    <td>{{ equipment.department.name|default:"-" }}</td>
                                    <td>{{ equipment.equipment_name }}</td>
                                    <td>{{ equipment.model|default:"-" }}</td>
                                    <td>{{ equipment.type|default:"-" }}</td>
                                    <td>{{ equipment.manufacturer|default:"-" }}</td>
                                    <td>{{ equipment.inventory_number }}</td>
                                    <td>{{ equipment.serial_number }}</td>
                                    <td>{{ equipment.location }}</td>
                                    <td>
                                        {% if equipment.inspection_type %}
                                            {{ equipment.get_inspection_type_display }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ equipment.inspection_institution|default:"-" }}</td>
                                    <td>{{ equipment.certificate_number_date|default:"-" }}</td>
                                    <td>{{ equipment.inspection_frequency|default:"-" }}</td>
                                    <td>
                                        {% if equipment.next_inspection_date %}
                                            {{ equipment.next_inspection_date|date:"d.m.Y" }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ equipment.technical_status|default:"-" }}</td>
                                    <td>{{ equipment.documentation|default:"-" }}</td>
                                    <td>{{ equipment.notes|truncatechars:30|default:"-" }}</td>
                                    <td>{{ equipment.responsible_person|default:"-" }}</td>
                                    <td>{{ equipment.additional_info|default:"-" }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'equipment:detail' equipment.id %}" class="btn btn-info" title="{% trans 'View' %}">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if equipment.manual_url %}
                                            <a href="{{ equipment.manual_url }}" class="btn btn-success" title="{% trans 'User Manual' %}" target="_blank">
                                                <i class="fas fa-book"></i>
                                            </a>
                                            {% endif %}
                                            {% if perms.equipment.change_equipment %}
                                            <a href="{% url 'equipment:update' equipment.id %}" class="btn btn-warning" title="{% trans 'Edit' %}">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    {% trans "No equipment found." %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find the navigation sidebar
        const navSidebar = document.getElementById('nav-sidebar');
        const contentWrapper = document.getElementById('content-wrapper');
        
        if (navSidebar && contentWrapper) {
            // Get the exact width of the navigation sidebar
            const navWidth = navSidebar.offsetWidth;
            
            // Set content to start exactly at the right edge of navigation
            contentWrapper.style.marginLeft = navWidth + 'px';
            
            // Ensure content doesn't overflow
            contentWrapper.style.width = `calc(100% - ${navWidth}px)`;
            
            // Remove any additional spacing
            contentWrapper.style.paddingLeft = '0';
        }
        
        // Initialize column visibility toggle
        const tableHeaders = document.querySelectorAll('.equipment-table th');
        const columnToggleMenu = document.querySelector('.column-visibility-menu');
        const tableContainer = document.getElementById('table-container');
        
        // Create toggle checkboxes for all columns - all checked by default
        if (tableHeaders.length > 0 && columnToggleMenu) {
            // Store column visibility preferences in localStorage
            const storedVisibility = localStorage.getItem('equipmentTableColumnVisibility');
            let columnVisibility = {};
            
            if (storedVisibility) {
                try {
                    columnVisibility = JSON.parse(storedVisibility);
                } catch (e) {
                    console.error('Error parsing stored column visibility settings:', e);
                }
            }
            
            tableHeaders.forEach((header, index) => {
                // Always keep the first column (Nr.p.) and last column (Actions) visible
                const isEssentialColumn = index === 0 || index === tableHeaders.length - 1;
                
                const columnName = header.textContent.trim();
                const columnId = `toggle-col-${index}`;
                const toggleDiv = document.createElement('div');
                toggleDiv.className = 'column-toggle';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = columnId;
                
                // Set checkbox state based on stored preferences, or default to checked
                if (columnVisibility.hasOwnProperty(columnId)) {
                    checkbox.checked = columnVisibility[columnId];
                } else {
                    checkbox.checked = true; // Default is all selected
                }
                
                checkbox.disabled = isEssentialColumn;
                
                const label = document.createElement('label');
                label.htmlFor = columnId;
                label.textContent = columnName;
                
                toggleDiv.appendChild(checkbox);
                toggleDiv.appendChild(label);
                columnToggleMenu.appendChild(toggleDiv);
                
                // Apply initial visibility state
                if (!checkbox.checked) {
                    toggleColumnVisibility(index, false);
                }
                
                // Add event listener to toggle column visibility
                checkbox.addEventListener('change', function() {
                    const isVisible = this.checked;
                    toggleColumnVisibility(index, isVisible);
                    
                    // Save preferences to localStorage
                    columnVisibility[columnId] = isVisible;
                    localStorage.setItem('equipmentTableColumnVisibility', JSON.stringify(columnVisibility));
                });
            });
            
            // Select/deselect all buttons
            document.getElementById('select-all-columns').addEventListener('click', function() {
                document.querySelectorAll('.column-toggle input:not(:disabled)').forEach(checkbox => {
                    checkbox.checked = true;
                    toggleColumnVisibility(parseInt(checkbox.id.replace('toggle-col-', '')), true);
                });
            });
            
            document.getElementById('deselect-all-columns').addEventListener('click', function() {
                document.querySelectorAll('.column-toggle input:not(:disabled)').forEach(checkbox => {
                    checkbox.checked = false;
                    toggleColumnVisibility(parseInt(checkbox.id.replace('toggle-col-', '')), false);
                });
            });
        }
        
        // Function to toggle column visibility
        function toggleColumnVisibility(colIndex, isVisible) {
            const table = document.querySelector('.equipment-table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                if (cells[colIndex]) {
                    if (isVisible) {
                        cells[colIndex].classList.remove('hidden-column');
                    } else {
                        cells[colIndex].classList.add('hidden-column');
                    }
                }
            });
        }
        
        // Horizontal scrolling controls
        const scrollLeftBtn = document.getElementById('scroll-left');
        const scrollRightBtn = document.getElementById('scroll-right');
        const tableContainer = document.getElementById('table-container');
        
        if (scrollLeftBtn && scrollRightBtn && tableContainer) {
            // Scroll left button
            scrollLeftBtn.addEventListener('click', function() {
                tableContainer.scrollLeft -= 200;
            });
            
            // Scroll right button
            scrollRightBtn.addEventListener('click', function() {
                tableContainer.scrollLeft += 200;
            });
            
            // Arrow key navigation
            document.addEventListener('keydown', function(e) {
                if (document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA' && 
                    document.activeElement.tagName !== 'SELECT') {
                    if (e.key === 'ArrowLeft') {
                        tableContainer.scrollLeft -= 200;
                        e.preventDefault();
                    } else if (e.key === 'ArrowRight') {
                        tableContainer.scrollLeft += 200;
                        e.preventDefault();
                    }
                }
            });
            
            // Just update button states on scroll
            tableContainer.addEventListener('scroll', function() {
                const scrollWidth = tableContainer.scrollWidth;
                const containerWidth = tableContainer.clientWidth;
                const scrollLeft = tableContainer.scrollLeft;
                
                // Update scroll button states
                scrollLeftBtn.disabled = scrollLeft <= 0;
                scrollRightBtn.disabled = scrollLeft + containerWidth >= scrollWidth;
            });
            
            // Initial update
            setTimeout(function() {
                const scrollWidth = tableContainer.scrollWidth;
                const containerWidth = tableContainer.clientWidth;
                const scrollLeft = tableContainer.scrollLeft;
                
                scrollLeftBtn.disabled = scrollLeft <= 0;
                scrollRightBtn.disabled = scrollLeft + containerWidth >= scrollWidth;
            }, 100);
        }
        
        // Add tooltip data for truncated cells
        const tableCells = document.querySelectorAll('.equipment-table td');
        tableCells.forEach(cell => {
            if (cell.scrollWidth > cell.clientWidth) {
                // If content is truncated, add full text as data attribute
                cell.setAttribute('data-full-text', cell.textContent);
                cell.title = cell.textContent; // Also add as title for native browser tooltip
            }
        });
        
        // Make the column selector dropdown toggle manually
        const columnToggleBtn = document.getElementById('columnToggleDropdown');
        const columnMenu = document.querySelector('.column-visibility-menu');
        
        if (columnToggleBtn && columnMenu) {
            // Use Bootstrap's dropdown API if available
            if (typeof bootstrap !== 'undefined') {
                const dropdown = new bootstrap.Dropdown(columnToggleBtn);
                
                // Custom click handler
                columnToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    dropdown.toggle();
                });
            } else {
                // Fallback if Bootstrap JavaScript is not loaded
                columnToggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const isOpen = columnToggleBtn.parentElement.classList.contains('show');
                    
                    if (isOpen) {
                        columnToggleBtn.parentElement.classList.remove('show');
                        columnMenu.style.display = 'none';
                    } else {
                        columnToggleBtn.parentElement.classList.add('show');
                        columnMenu.style.display = 'block';
                    }
                });
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    if (!columnToggleBtn.contains(e.target) && !columnMenu.contains(e.target)) {
                        columnToggleBtn.parentElement.classList.remove('show');
                        columnMenu.style.display = 'none';
                    }
                });
            }
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ...existing code...
        
        // Fix for the column selector dropdown
        const columnToggleBtn = document.getElementById('columnToggleDropdown');
        const columnMenu = document.querySelector('.column-visibility-menu');
        const columnToggleDropdown = document.querySelector('.dropdown');
        
        if (columnToggleBtn && columnMenu) {
            // Initialize column visibility toggle
            const tableHeaders = document.querySelectorAll('.equipment-table th');
            
            // Clear any existing checkboxes to prevent duplicates
            const existingToggles = columnMenu.querySelectorAll('.column-toggle:not(.column-toggle-all)');
            existingToggles.forEach(toggle => toggle.remove());
            
            // Create toggle checkboxes for all columns
            if (tableHeaders.length > 0) {
                // Get stored visibility preferences
                const storedVisibility = localStorage.getItem('equipmentTableColumnVisibility');
                let columnVisibility = {};
                
                if (storedVisibility) {
                    try {
                        columnVisibility = JSON.parse(storedVisibility);
                    } catch (e) {
                        console.error('Error parsing stored column visibility settings:', e);
                    }
                }
                
                tableHeaders.forEach((header, index) => {
                    // Always keep the first column (Nr.p.) and last column (Actions) visible
                    const isEssentialColumn = index === 0 || index === tableHeaders.length - 1;
                    
                    const columnName = header.textContent.trim();
                    const columnId = `toggle-col-${index}`;
                    const toggleDiv = document.createElement('div');
                    toggleDiv.className = 'column-toggle form-check';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = columnId;
                    checkbox.className = 'form-check-input';
                    
                    // Set checkbox state based on stored preferences, or default to checked
                    if (columnVisibility.hasOwnProperty(index)) {
                        checkbox.checked = columnVisibility[index];
                    } else {
                        checkbox.checked = true; // Default is all selected
                    }
                    
                    if (isEssentialColumn) {
                        checkbox.checked = true;
                        checkbox.disabled = true;
                    }
                    
                    const label = document.createElement('label');
                    label.htmlFor = columnId;
                    label.className = 'form-check-label';
                    label.textContent = columnName;
                    
                    toggleDiv.appendChild(checkbox);
                    toggleDiv.appendChild(label);
                    columnMenu.appendChild(toggleDiv);
                    
                    // Apply initial visibility state
                    toggleColumnVisibility(index, checkbox.checked);
                    
                    // Add event listener to toggle column visibility
                    checkbox.addEventListener('change', function() {
                        const isVisible = this.checked;
                        toggleColumnVisibility(index, isVisible);
                        
                        // Save preferences to localStorage - use index as key
                        columnVisibility[index] = isVisible;
                        localStorage.setItem('equipmentTableColumnVisibility', JSON.stringify(columnVisibility));
                    });
                });
            }
            
            // Fix for dropdown toggle
            columnToggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                columnToggleDropdown.classList.toggle('show');
                columnMenu.classList.toggle('show');
                
                if (columnToggleDropdown.classList.contains('show')) {
                    columnMenu.style.display = 'block';
                } else {
                    columnMenu.style.display = 'none';
                }
            });
            
            // Fix for select/deselect all
            document.getElementById('select-all-columns').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.querySelectorAll('.column-toggle input:not(:disabled)').forEach((checkbox, idx) => {
                    checkbox.checked = true;
                    const colIndex = parseInt(checkbox.id.replace('toggle-col-', ''));
                    toggleColumnVisibility(colIndex, true);
                    
                    // Update localStorage
                    columnVisibility[colIndex] = true;
                });
                localStorage.setItem('equipmentTableColumnVisibility', JSON.stringify(columnVisibility));
            });
            
            document.getElementById('deselect-all-columns').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.querySelectorAll('.column-toggle input:not(:disabled)').forEach((checkbox) => {
                    checkbox.checked = false;
                    const colIndex = parseInt(checkbox.id.replace('toggle-col-', ''));
                    toggleColumnVisibility(colIndex, false);
                    
                    // Update localStorage
                    columnVisibility[colIndex] = false;
                });
                localStorage.setItem('equipmentTableColumnVisibility', JSON.stringify(columnVisibility));
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!columnToggleDropdown.contains(e.target)) {
                    columnToggleDropdown.classList.remove('show');
                    columnMenu.classList.remove('show');
                    columnMenu.style.display = 'none';
                }
            });
        }
        
        // Improved function to toggle column visibility
        function toggleColumnVisibility(colIndex, isVisible) {
            const table = document.querySelector('.equipment-table');
            if (!table) return;
            
            // First and last columns should always stay visible
            if (colIndex === 0 || colIndex === table.querySelectorAll('th').length - 1) {
                isVisible = true;
            }
            
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cell = row.children[colIndex];
                if (cell) {
                    cell.style.display = isVisible ? '' : 'none';
                }
            });
        }
        
        // ...existing code...
    });
</script>

<script>
// ...existing code...

// Enhanced horizontal scrolling controls
const scrollLeftBtn = document.getElementById('scroll-left');
const scrollRightBtn = document.getElementById('scroll-right');
const tableContainer = document.getElementById('table-container');

if (scrollLeftBtn && scrollRightBtn && tableContainer) {
    // Calculate appropriate scroll distance based on table width
    const calculateScrollDistance = () => {
        return Math.max(200, Math.floor(tableContainer.clientWidth * 0.3));
    };
    
    // Scroll left button with smooth animation
    scrollLeftBtn.addEventListener('click', function() {
        const scrollDistance = calculateScrollDistance();
        tableContainer.scrollBy({
            left: -scrollDistance,
            behavior: 'smooth'
        });
    });
    
    // Scroll right button with smooth animation
    scrollRightBtn.addEventListener('click', function() {
        const scrollDistance = calculateScrollDistance();
        tableContainer.scrollBy({
            left: scrollDistance,
            behavior: 'smooth'
        });
    });
    
    // Arrow key navigation
    document.addEventListener('keydown', function(e) {
        // Only handle arrow keys when focus is on the table or document body
        if ((document.activeElement === document.body || 
             tableContainer.contains(document.activeElement) ||
             document.activeElement.tagName === 'TH' || 
             document.activeElement.tagName === 'TD') && 
            !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
            
            const scrollDistance = calculateScrollDistance();
            
            if (e.key === 'ArrowLeft') {
                tableContainer.scrollBy({
                    left: -scrollDistance,
                    behavior: 'smooth'
                });
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                tableContainer.scrollBy({
                    left: scrollDistance,
                    behavior: 'smooth'
                });
                e.preventDefault();
            }
        }
    });
}

// ...existing code...
</script>
{% endblock %}

