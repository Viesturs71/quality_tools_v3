{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% if form.instance.id %}{% trans "Edit Equipment" %}{% else %}{% trans "Add New Equipment" %}{% endif %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <h1 class="text-3xl font-bold mb-6 font-serif">
        {% if form.instance.id %}{% trans "Edit Equipment" %}{% else %}{% trans "Add New Equipment" %}{% endif %}
    </h1>

    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        <!-- General Information Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold font-serif border-b pb-2 mb-4">{% trans "General Information" %}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.name.label }}{% if form.name.field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.name.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.equipment_type.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.equipment_type.label }}{% if form.equipment_type.field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    {{ form.equipment_type }}
                    <div class="text-sm text-gray-500 mt-1">{% trans "Select equipment type - metrological control is required for measuring instruments" %}</div>
                    {% if form.equipment_type.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.equipment_type.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.model.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.model.label }}
                    </label>
                    {{ form.model }}
                    {% if form.model.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.model.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.type.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.type.label }}
                    </label>
                    {{ form.type }}
                    {% if form.type.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.type.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.manufacturer.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.manufacturer.label }}
                    </label>
                    {{ form.manufacturer }}
                    {% if form.manufacturer.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.manufacturer.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.inventory_number.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.inventory_number.label }}{% if form.inventory_number.field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    {{ form.inventory_number }}
                    {% if form.inventory_number.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.inventory_number.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.serial_number.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.serial_number.label }}{% if form.serial_number.field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    {{ form.serial_number }}
                    {% if form.serial_number.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.serial_number.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.location.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {{ form.location.label }}{% if form.location.field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    {{ form.location }}
                    {% if form.location.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.location.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Documentation Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold font-serif border-b pb-2 mb-4">{% trans "Documentation" %}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group md:col-span-2">
                    <label for="{{ form.manual_file.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "User Manual Document" %}
                    </label>
                    {{ form.manual_file }}
                    <div class="text-sm text-gray-500 mt-1">{% trans "Max. filesize 1MB. PDF format only." %}</div>
                    {% if form.manual_file.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.manual_file.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group md:col-span-2">
                    <label for="{{ form.manual_url.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "User Manual URL" %}
                    </label>
                    {{ form.manual_url }}
                    <div class="text-sm text-gray-500 mt-1">{% trans "Link to online documentation" %}</div>
                    {% if form.manual_url.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.manual_url.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group md:col-span-2">
                    <label for="{{ form.documentation.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Additional Documentation" %}
                    </label>
                    {{ form.documentation }}
                    {% if form.documentation.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.documentation.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Department Information Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold font-serif border-b pb-2 mb-4">{% trans "Department Information" %}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="{{ form.department.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Department/Structural Unit" %}
                    </label>
                    {{ form.department }}
                    {% if form.department.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.department.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.responsible_person.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Person Responsible" %}
                    </label>
                    {{ form.responsible_person }}
                    {% if form.responsible_person.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.responsible_person.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Dates and Financial Information Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold font-serif border-b pb-2 mb-4">{% trans "Dates and Financial Information" %}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-group">
                    <label for="{{ form.manufacture_date.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Manufacture Date" %}
                    </label>
                    {{ form.manufacture_date }}
                    {% if form.manufacture_date.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.manufacture_date.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.purchase_date.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Purchase Date" %}
                    </label>
                    {{ form.purchase_date }}
                    {% if form.purchase_date.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.purchase_date.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.purchase_price.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Purchase Price" %}
                    </label>
                    {{ form.purchase_price }}
                    {% if form.purchase_price.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.purchase_price.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Metrological Control Section (shown only for measuring instruments) -->
        <div id="metrological-control-section" class="bg-white rounded-lg shadow-md p-6 {% if not is_measuring_instrument %}hidden{% endif %}">
            <h2 class="text-xl font-bold font-serif border-b pb-2 mb-4">{% trans "Metrological Control" %}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="{{ form.metrological_control_type.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Metrological Control Type" %}
                    </label>
                    {{ form.metrological_control_type }}
                    {% if form.metrological_control_type.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.metrological_control_type.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.metrological_control_institution.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Metrological Control Institution" %}
                    </label>
                    {{ form.metrological_control_institution }}
                    {% if form.metrological_control_institution.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.metrological_control_institution.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.certificate_number.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Certificate Number/Date" %}
                    </label>
                    {{ form.certificate_number }}
                    {% if form.certificate_number.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.certificate_number.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.metrological_control_periodicity.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Metrological Control Periodicity" %}
                    </label>
                    {{ form.metrological_control_periodicity }}
                    {% if form.metrological_control_periodicity.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.metrological_control_periodicity.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.next_verification_date.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Next Verification Date" %}
                    </label>
                    {{ form.next_verification_date }}
                    {% if form.next_verification_date.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.next_verification_date.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Status Information Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold font-serif border-b pb-2 mb-4">{% trans "Status Information" %}</h2>
            
            <div class="grid grid-cols-1 gap-4">
                <div class="form-group">
                    <label for="{{ form.technical_status.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Technical Status" %}
                    </label>
                    {{ form.technical_status }}
                    {% if form.technical_status.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.technical_status.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.additional_info.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Additional Information" %}
                    </label>
                    {{ form.additional_info }}
                    {% if form.additional_info.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.additional_info.errors }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}" class="block font-serif font-medium text-gray-700 mb-1">
                        {% trans "Notes" %}
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.notes.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Form Buttons -->
        <div class="flex justify-end space-x-4">
            <a href="{% url 'equipment:index' %}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                {% trans "Cancel" %}
            </a>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                {% trans "Save Equipment" %}
            </button>
        </div>
    </form>
</div>

<!-- JavaScript for dynamic form behavior -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const equipmentTypeSelect = document.getElementById('{{ form.equipment_type.id_for_label }}');
        const metrologicalSection = document.getElementById('metrological-control-section');
        
        // Function to toggle metrological control section based on equipment type
        function toggleMetrologicalSection() {
            if (equipmentTypeSelect && metrologicalSection) {
                const selectedOption = equipmentTypeSelect.options[equipmentTypeSelect.selectedIndex];
                const isMeasuringInstrument = selectedOption && selectedOption.text.toLowerCase().includes('measuring instrument');
                
                if (isMeasuringInstrument) {
                    metrologicalSection.classList.remove('hidden');
                } else {
                    metrologicalSection.classList.add('hidden');
                }
            }
        }
        
        // Initial check
        toggleMetrologicalSection();
        
        // Listen for changes
        if (equipmentTypeSelect) {
            equipmentTypeSelect.addEventListener('change', toggleMetrologicalSection);
        }
    });
</script>
{% endblock %}